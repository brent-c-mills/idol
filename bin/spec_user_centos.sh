#!/bin/bash

#################################
##          FUNCTIONS          ##
#################################

create_spec_test() {
	mkdir  -p ${serverspec_dir};
	touch ${spec_test};

	echo "# This file has been auto-generated by Idol." >> ${spec_test};
	echo "" >> ${spec_test};
	echo "require 'serverspec'" >> ${spec_test};
	echo "require 'spec_helper'" >> ${spec_test};
	echo "" >> ${spec_test};
	echo "# Required by serverspec" >> ${spec_test};
	echo "set :backend, :exec" >> ${spec_test};
	echo "" >> ${spec_test};
}

describe_spec() {

	echo "# User: "${user_name} >> ${spec_test};
	echo "describe user('"${user_name}"') do" >> ${spec_test};
	echo "  it { should exist }" >> ${spec_test};
	echo "  it { should have_uid "${user_id}" }" >> ${spec_test};
	echo "  it { should have_home_directory '"${user_home}"' }" >> ${spec_test};
	echo "  it { should have_login_shell '"${user_shell}"' }" >> ${spec_test};
	echo "end" >> ${spec_test};
	echo "" >> ${spec_test};
}

read_all_users() {
	user_count=$(cat /etc/passwd | cut -f 1,3,6,7 -d : > /tmp/user && wc -l /tmp/user | awk '{ print $1 }');
	echo "User Count is: "${user_count};

	perl -pi -e 's/:/ /g' /tmp/user

	for (( i=1; i<=${user_count}; i++ )); do
		read_individual_user;
	done;

	rm /tmp/user;
}

read_individual_user() {
	local user_name=$(sed "${i}q;d" /tmp/user | awk '{ print $1 }');
	local user_id=$(sed "${i}q;d" /tmp/user | awk '{ print $2 }');
	local user_home=$(sed "${i}q;d" /tmp/user | awk '{ print $3 }');
	local user_shell=$(sed "${i}q;d" /tmp/user | awk '{ print $4 }');
	
	describe_spec ${user_name} ${user_id} ${user_spec} ${user_shell};
}

#################################
##     INPUT AND VARIABLES     ##
#################################
serverspec_dir=${HOME}/serverspec_tests;
spec_test="${serverspec_dir}/user_spec.rb";

#################################
##      CREATE SPEC TESTS      ##
#################################
create_spec_test;
read_all_users;

#!/bin/bash

#################################
##          FUNCTIONS          ##
#################################

create_spec_test() {
	mkdir -p ${serverspec_dir};
	touch ${spec_test};

	echo "# This file has been auto-generated by Idol." >> ${spec_test};
	echo "" >> ${spec_test};
	echo "require 'serverspec'" >> ${spec_test};
	echo "require 'spec_helper'" >> ${spec_test};
	echo "" >> ${spec_test};
	echo "# Required by serverspec" >> ${spec_test};
	echo "set :backend, :exec" >> ${spec_test};
	echo "" >> ${spec_test};

}

describe_spec() {
	local file_name=${1};
	local file_perms=$(sudo stat -c "%a %n" ${file_name} | awk '{ print $1 }');
	echo "describe file('"${file_name}"') do" >> ${spec_test};
	
	if (sudo find /etc/ -maxdepth 2 -name *.conf | grep ${file_name} >> /dev/null); then
		echo "  it { should be_file }" >> ${spec_test};
		echo "  it { should be_mode "${file_perms}" }" >> ${spec_test};
	fi

	read_file_lines ${file_name};

	echo "end" >> ${spec_test};
	echo "" >> ${spec_test};
}

read_all_files() {
	sudo find /etc/ -maxdepth 2 -name *.conf > /tmp/conf_files;
	sudo find /etc/ -maxdepth 3 -name *.cfg >> /tmp/conf_files;
	file_count=$( wc -l /tmp/conf_files | awk '{ print $1 }');
	echo "File Count is: "${file_count};

	for (( i=1; i<=${file_count}; i++ )); do
		read_individual_file;
	done;

	rm /tmp/conf_files;
}

read_file_lines() {
	local file_name=${1}
  while read -r file_line || [[ -n $file_line ]]; do
    IFS=' ' read -a array <<< ${file_line};
    if [[ ${array[0]} ]] && [[ ! ${array[0]} =~ \# ]] && [[ ! ${file_line} =~ \[ ]] && [[ ! ${file_line} =~ \` ]]; then
      echo "  it { should contain '"${file_line}"' }" >> ${spec_test};
    fi;
  done < ${file_name};
}

read_individual_file() {
	local file_name=$(sed "${i}q;d" /tmp/conf_files);
	describe_spec ${file_name};
}

#################################
##     INPUT AND VARIABLES     ##
#################################
serverspec_dir=${HOME}/serverspec_tests;
spec_test="${serverspec_dir}/files_spec.rb";

#################################
##      CREATE SPEC TESTS      ##
#################################
create_spec_test;
read_all_files;

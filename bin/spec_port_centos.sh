#!/bin/bash

#################################
##          FUNCTIONS          ##
#################################

create_spec_test() {
	mkdir  -p ${serverspec_dir};
	touch ${spec_test};

	echo "# This file has been auto-generated by Idol." >> ${spec_test};
	echo "" >> ${spec_test};
	echo "require 'serverspec'" >> ${spec_test};
	echo "require 'spec_helper'" >> ${spec_test};
	echo "" >> ${spec_test};
	echo "# Required by serverspec" >> ${spec_test};
	echo "set :backend, :exec" >> ${spec_test};
	echo "" >> ${spec_test};
}

describe_spec() {
	local service_name=${1};
	local service_port=${2};

	echo "# Service: "${service_name} >> ${spec_test};
	echo "describe port("${service_port}") do" >> ${spec_test};
	echo "  it { should be_listening }" >> ${spec_test};
	echo "end" >> ${spec_test};
	echo "" >> ${spec_test};
}

read_all_ports_tcp() {
	tcp_port_count=$(sudo netstat -plnt --tcp | tail -n +3 >> /tmp/port && wc -l /tmp/port | awk '{ print $1 }');
	echo "Listening TCP Port Count is: "${tcp_port_count};

	for (( i=1; i<=${tcp_port_count}; i++ )); do
		read_individual_port_tcp;
	done;

	rm /tmp/port;
}

read_all_ports_udp() {
	udp_port_count=$(sudo netstat -plnt --udp | tail -n +3 >> /tmp/port && wc -l /tmp/port | awk '{ print $1 }');
	echo "Listening UDP Port Count is: "${udp_port_count};

	for (( i=1; i<=${udp_port_count}; i++ )); do
		read_individual_port_udp;
	done;

#	rm /tmp/port;
}

read_individual_port_tcp() {
	local service_name=$(sed "${i}q;d" /tmp/port | awk 'NF>1{print $NF}');
	local service_name=${service_name##*/};
	local service_port=$(sed "${i}q;d" /tmp/port | awk '{ print $4 }');
	local service_port=${service_port##*:};

	describe_spec ${service_name} ${service_port};
}

read_individual_port_udp() {
	local service_name=$(sed "${i}q;d" /tmp/port | awk 'NF>1{print $NF}');
	local service_name=${service_name##*/};
	local service_port=$(sed "${i}q;d" /tmp/port | awk '{ print $4 }');
	local service_port=${service_port##*:};

	describe_spec ${service_name} ${service_port};
}

#################################
##     INPUT AND VARIABLES     ##
#################################
serverspec_dir=${HOME}/serverspec_tests;
spec_test="${serverspec_dir}/port_spec.rb";

#################################
##      CREATE SPEC TESTS      ##
#################################
create_spec_test;
read_all_ports_tcp;
read_all_ports_udp;
